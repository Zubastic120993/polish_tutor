<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient Polish Tutor ‚Äì Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/output.css">
    <link rel="stylesheet" href="/static/css/dashboard-modern.css">
    <link rel="stylesheet" href="/static/css/modern-ui.css">
</head>

<body id="top" class="dashboard-body">

<!-- TOAST -->
<div id="dashboard-toast" class="hidden fixed top-6 right-6 z-50 max-w-sm w-full bg-white shadow-2xl border border-slate-200 rounded-2xl p-4">
    <div class="flex items-start gap-3">
        <div id="dashboard-toast-icon" class="mt-1 h-3 w-3 rounded-full bg-blue-500"></div>
        <div class="flex-1">
            <p id="dashboard-toast-title" class="font-semibold text-slate-900">Action completed</p>
            <p id="dashboard-toast-message" class="text-sm text-slate-600 mt-1">Lesson data has been updated.</p>
        </div>
        <button type="button" id="dashboard-toast-close" class="text-slate-400 hover:text-slate-600">&times;</button>
    </div>
</div>
{% include "includes/theme-script.html" %}

<div class="dashboard-wrapper">
    <header class="dashboard-header">
        <div class="brand">
            <span class="brand-mark">üáµüá±</span>
            <div>
                <p class="brand-eyebrow">Patient Polish Tutor</p>
                <h1 class="brand-title">Learning Dashboard</h1>
            </div>
        </div>
        <nav class="dashboard-nav">
            <a href="#daily-mission">Mission</a>
            <a href="#recommended">Featured</a>
            <a href="#continue-learning">Lessons</a>
            <a href="#lesson-preview">Preview</a>
            <a href="/settings">Settings</a>
        </nav>
    </header>

    <div class="dashboard-columns">
        <div class="dashboard-main">
            <!-- DAILY MISSION -->
            <section class="dashboard-card mission-card" id="daily-mission">
                <div class="card-heading">
                    <h2>Daily Mission</h2>
                    <p>Complete a focused 5-minute drill to keep your streak alive.</p>
                </div>
                <div class="mission-content">
                    <div class="mission-buttons">
                        <button data-action="start-recommended" class="btn-primary mission-primary">
                            ‚ñ∂ Start Recommended Lesson
                        </button>
                    </div>
                    <div class="streak-chip">üî• 3-day streak</div>
                </div>
                <div class="progress-row">
                    <div class="progress-labels">
                        <span>XP Progress</span>
                        <span>120 / 500 XP</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill"></div>
                    </div>
                </div>
            </section>

            <!-- FEATURED LESSON -->
            <section class="dashboard-card featured-card" id="recommended" data-featured-lesson="A1_L01">
                <div class="card-heading">
                    <h2>‚≠ê Featured Lesson</h2>
                    <p>Hand-picked based on your pace and recent accuracy.</p>
                </div>
                <div class="featured-body">
                    <div>
                        <p class="featured-meta">Level A1 ‚Ä¢ 3 min ‚Ä¢ 3 phrases</p>
                        <h3>Powitania i po≈ºegnania</h3>
                        <p class="featured-description">
                            Perfect your greeting and farewell patterns for both formal and informal settings.
                        </p>
                        <ul class="feature-tags">
                            <li>Speaking drill</li>
                            <li>3 dialogues</li>
                            <li>Polite forms</li>
                        </ul>
                    </div>
                    <button data-action="resume-lesson" data-lesson-id="A1_L01" class="btn-outline featured-button">
                        <span data-resume-label>Resume lesson</span>
                    </button>
                </div>
            </section>

            <!-- CONTINUE LEARNING -->
            <section class="dashboard-card continue-card" id="continue-learning">
                <div class="card-heading">
                    <h2>Continue Learning</h2>
                    <p>Hand-selected drills based on your confidence scores.</p>
                </div>
                <div class="lesson-grid">
                    <article class="lesson-card">
                        <div class="lesson-card-header">
                            <span class="lesson-tag">General health</span>
                            <span class="lesson-time">A1 ‚Ä¢ 3 min</span>
                        </div>
                        <h3>Boli mnie g≈Çowa</h3>
                        <p>Learn to describe symptoms and ask for help politely.</p>
                        <button data-action="start-lesson" data-lesson-id="A1_L51" class="btn-primary lesson-button">
                            Start drill
                        </button>
                    </article>
                    <article class="lesson-card">
                        <div class="lesson-card-header">
                            <span class="lesson-tag">Weather talk</span>
                            <span class="lesson-time">A1 ‚Ä¢ 2 min</span>
                        </div>
                        <h3>Deszcz ze ≈õniegiem</h3>
                        <p>Blend weather phrases for casual conversations.</p>
                        <button data-action="start-lesson" data-lesson-id="A1_L49" class="btn-primary lesson-button">
                            Start drill
                        </button>
                    </article>
                    <article class="lesson-card">
                        <div class="lesson-card-header">
                            <span class="lesson-tag">Daily life</span>
                            <span class="lesson-time">A1 ‚Ä¢ 4 min</span>
                        </div>
                        <h3>O kt√≥rej zaczynasz pracƒô?</h3>
                        <p>Practice polite questions around schedules.</p>
                        <button data-action="start-lesson" data-lesson-id="A1_L43" class="btn-primary lesson-button">
                            Start drill
                        </button>
                    </article>
                </div>
            </section>

        <!-- PREVIEW -->
        <section class="dashboard-card preview-card" id="lesson-preview">
            <div class="card-heading">
                <h2>Live Preview</h2>
                <p>Use any button above to load lesson data.</p>
            </div>
                <div class="preview-meta">
                    <div class="preview-cefr">
                        <span id="lesson-preview-level" class="preview-level">A1</span>
                        <span class="cefr-short" id="lesson-preview-descriptor">Level A1 ‚Äî lesson focus</span>
                        <span class="tooltip" id="lesson-preview-tooltip">i
                            <span class="tooltip-text" id="lesson-preview-tooltip-text">Descriptor details will appear once a lesson loads.</span>
                        </span>
                    </div>
                </div>
                <p id="lesson-preview-goal" class="preview-info">Click the info icon for descriptor details.</p>
                <div id="lesson-preview-empty" class="preview-empty">
                    <span class="preview-spinner"></span>
                    <span id="lesson-preview-empty-text">Lesson dialogues will appear here once loaded.</span>
                </div>
                <div id="lesson-preview-container" class="preview-content">
                    <div id="lesson-preview-dialogues" class="dialogue-list hidden">
                        <!-- Dialogues injected -->
                    </div>
                </div>
        </section>

            <!-- LIBRARY -->
            <section class="dashboard-card library-card">
                <div class="card-heading">
                    <h2>Lesson Library</h2>
                    <p>Browse lessons saved to your account.</p>
                </div>
                <div class="library-actions">
                    <button data-action="open-library" class="btn-outline">Browse full lesson library</button>
                </div>
                <div id="lesson-catalog-empty" class="library-empty-state">
                    <p>üìö No lessons available yet</p>
                    <p>Try refreshing or browsing all categories.</p>
                </div>
                <div id="lesson-catalog-list" class="library-list hidden">
                    <!-- Catalog rows -->
                </div>
            </section>
        </div>

        <aside class="dashboard-side">
            <section class="dashboard-card stats-card">
                <h3>Your Stats</h3>
                <div class="stat-item">
                    <div class="stat-icon">‚òÖ</div>
                    <div>
                        <p>XP Progress</p>
                        <strong>120 / 500 XP</strong>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">‚úé</div>
                    <div>
                        <p>Phrases mastered</p>
                        <strong>32 / 40</strong>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">üî•</div>
                    <div>
                        <p>Current streak</p>
                        <strong>3 days</strong>
                    </div>
                </div>
            </section>

            <section class="dashboard-card level-card">
                <h3>Current Level</h3>
                <p class="level-display">A0 ‚Üí A1</p>
                <p class="level-meta">+18% this month</p>
            </section>
        </aside>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const toast = document.getElementById("dashboard-toast");
    const toastTitle = document.getElementById("dashboard-toast-title");
    const toastMessage = document.getElementById("dashboard-toast-message");
    const toastIcon = document.getElementById("dashboard-toast-icon");
    const toastClose = document.getElementById("dashboard-toast-close");
    const previewTitle = document.getElementById("lesson-preview-title");
    const previewMeta = document.getElementById("lesson-preview-meta");
    const previewDescriptor = document.getElementById("lesson-preview-descriptor");
    const previewGoal = document.getElementById("lesson-preview-goal");
    const previewLevel = document.getElementById("lesson-preview-level");
    const previewTooltip = document.getElementById("lesson-preview-tooltip");
    const previewTooltipText = document.getElementById("lesson-preview-tooltip-text");
    const previewEmpty = document.getElementById("lesson-preview-empty");
    const previewEmptyText = document.getElementById("lesson-preview-empty-text");
    const previewDialogues = document.getElementById("lesson-preview-dialogues");
    const catalogEmpty = document.getElementById("lesson-catalog-empty");
    const catalogList = document.getElementById("lesson-catalog-list");
    const resumeButtons = document.querySelectorAll("[data-action='resume-lesson']");
    const resumeLabels = document.querySelectorAll("[data-resume-label]");
    const featuredCard = document.querySelector(".featured-card");
    const featuredLessonId = featuredCard?.dataset.featuredLesson;
    const lessonEnglishCache = {};
    const tutorAudioCache = new Map();
    const userSettings = resolveUserSettings();
    const currentUserId = resolveCurrentUserId();
    let toastTimeout;
    let audioToastTimeout = null;
    let audioToastFadeTimeout = null;
    let currentLessonId = null;

    const toastVariants = {
        success: "bg-emerald-500",
        error: "bg-rose-500",
        info: "bg-blue-500"
    };

    function showToast(title, message, variant = "info") {
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        toast.classList.remove("hidden");
        toastIcon.className = `mt-1 h-3 w-3 rounded-full ${toastVariants[variant] || toastVariants.info}`;
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => toast.classList.add("hidden"), 4500);
    }

    toastClose.addEventListener("click", () => toast.classList.add("hidden"));

    function showAudioToast(message = "üîä Playing audio‚Ä¶") {
        if (!document?.body) {
            return;
        }
        if (audioToastTimeout) {
            clearTimeout(audioToastTimeout);
            audioToastTimeout = null;
        }
        if (audioToastFadeTimeout) {
            clearTimeout(audioToastFadeTimeout);
            audioToastFadeTimeout = null;
        }
        const existing = document.getElementById("audio-toast");
        if (existing) {
            existing.remove();
        }
        const toast = document.createElement("div");
        toast.id = "audio-toast";
        toast.textContent = message;
        Object.assign(toast.style, {
            position: "fixed",
            bottom: "24px",
            right: "24px",
            background: "var(--color-surface, #ffffff)",
            color: "var(--color-text, #0f172a)",
            border: "1px solid rgba(226, 232, 240, 0.8)",
            padding: "10px 16px",
            borderRadius: "12px",
            boxShadow: "var(--shadow-md, 0 18px 30px rgba(15, 23, 42, 0.12))",
            opacity: "0",
            transition: "opacity 0.4s ease",
            zIndex: "9999",
            pointerEvents: "none",
        });
        document.body.appendChild(toast);
        requestAnimationFrame(() => {
            toast.style.opacity = "1";
        });
        audioToastTimeout = setTimeout(() => {
            toast.style.opacity = "0";
            audioToastFadeTimeout = setTimeout(() => toast.remove(), 400);
        }, 2500);
    }

    function setPreviewLoading(message) {
        previewDialogues.innerHTML = "";
        previewDialogues.classList.add("hidden");
        previewEmpty.classList.remove("hidden");
        if (previewEmptyText) {
            previewEmptyText.textContent = message || "Loading lesson data‚Ä¶";
        }
    }

    function resetLessonPreview() {
        if (previewTitle) previewTitle.textContent = "Pick a lesson to view details";
        if (previewMeta) previewMeta.textContent = "Use any button above to load lesson data.";
        if (previewDescriptor) previewDescriptor.textContent = "Level A1 ‚Äî lesson focus";
        if (previewGoal) previewGoal.textContent = "Click the info icon for descriptor details.";
        if (previewTooltipText) previewTooltipText.textContent = "Descriptor details will appear once a lesson loads.";
        if (previewTooltip) {
            previewTooltip.setAttribute("aria-label", "Lesson descriptor");
            previewTooltip.setAttribute("title", "Lesson descriptor");
        }
        if (previewLevel) previewLevel.textContent = "A1";
        setPreviewLoading("Lesson dialogues will appear here once loaded.");
    }

    function resolveUserSettings() {
        if (window.userSettings && typeof window.userSettings === "object") {
            return {
                ...window.userSettings,
                audio_speed: window.userSettings.audio_speed || "normal",
            };
        }
        try {
            const stored = localStorage.getItem("userSettings");
            if (stored) {
                const parsed = JSON.parse(stored);
                if (!parsed.audio_speed) {
                    parsed.audio_speed = "normal";
                }
                return parsed;
            }
        } catch (settingsErr) {
            console.warn("Failed to load user settings:", settingsErr);
        }
        return { audio_speed: "normal" };
    }

    function resolveCurrentUserId() {
        const candidates = [window.currentUser, window.dashboardUser, window.user, window.USER];
        for (const candidate of candidates) {
            if (!candidate) continue;
            if (typeof candidate === "number" || typeof candidate === "string") {
                return candidate;
            }
            if (typeof candidate === "object") {
                const id = candidate.id || candidate.user_id || candidate.pk || candidate.uuid;
                if (id !== undefined && id !== null) {
                    return id;
                }
            }
        }
        const fallbackId = document.body?.dataset?.userId;
        return fallbackId || null;
    }

    function summarizeDescriptor(text) {
        if (!text) return "Conversation goal available soon.";
        return text.length > 70 ? `${text.slice(0, 67)}‚Ä¶` : text;
    }

    function renderLessonPreview(lesson) {
        if (!lesson) {
            resetLessonPreview();
            return;
        }
        console.log("renderLessonPreview called with lesson:", lesson?.id, lesson);

        if (previewTitle) previewTitle.textContent = lesson.title || lesson.id || "Lesson details";
        const metaParts = [];
        if (lesson.level) metaParts.push(`Level ${lesson.level}`);
        if (lesson.module) metaParts.push(lesson.module);
        if (lesson.tags?.length) metaParts.push(lesson.tags.slice(0, 2).join(", "));
        if (previewMeta) previewMeta.textContent = metaParts.length ? metaParts.join(" ‚Ä¢ ") : "Structured lesson from your tutor.";
        if (previewLevel) previewLevel.textContent = lesson.level || "A1";
        const descriptor = lesson.cefr_goal || "Conversation goal available soon.";
        const shortDescriptor = summarizeDescriptor(descriptor);
        if (previewDescriptor) {
            const levelLabel = lesson.level ? `${lesson.level} ‚Äî ` : "";
            previewDescriptor.textContent = `${levelLabel}${shortDescriptor}`;
        }
        if (previewGoal) {
            previewGoal.textContent = "Click the info icon for the full descriptor.";
        }
        if (previewTooltipText) {
            previewTooltipText.textContent = descriptor;
        }
        if (previewTooltip) {
            previewTooltip.setAttribute("aria-label", descriptor);
            previewTooltip.setAttribute("title", descriptor);
        }

        const dialogues = lesson.dialogues || [];
        console.log("dialogues count:", dialogues.length);
        previewDialogues.innerHTML = "";
        if (!dialogues.length) {
            if (previewEmptyText) previewEmptyText.textContent = "This lesson contains no dialogues yet.";
            previewDialogues.classList.add("hidden");
            previewEmpty.classList.remove("hidden");
            return;
        }

        previewEmpty.classList.add("hidden");
        if (previewEmptyText) previewEmptyText.textContent = "";
        previewDialogues.classList.remove("hidden");

        try {
            dialogues.forEach((dialogue, idx) => {
                const entry = document.createElement("div");
                entry.className = "dialogue-entry";

                const tutorBubble = document.createElement("div");
                tutorBubble.className = "dialogue-bubble tutor-bubble";
                const tutorLineRaw = dialogue.tutor ?? dialogue.text ?? "‚Äî";
                const tutorLine = typeof tutorLineRaw === "string" ? tutorLineRaw : String(tutorLineRaw ?? "‚Äî");
                tutorBubble.innerHTML = `<span class="dialogue-number">${idx + 1}</span><div><strong>Tutor:</strong> ${
                    tutorLine
                }</div>`;
                const trimmedLine = tutorLine.trim();
                const replayBtn = document.createElement("button");
                replayBtn.type = "button";
                replayBtn.className = "replay-audio-btn";
                replayBtn.setAttribute("aria-label", "Replay Tutor Audio");
                replayBtn.title = "Replay Tutor Audio";
                replayBtn.innerHTML = "&#9658;";
                if (trimmedLine) {
                    replayBtn.addEventListener("click", (event) => {
                        event.stopPropagation();
                        playTutorAudio(trimmedLine);
                    });
                } else {
                    replayBtn.disabled = true;
                }
                tutorBubble.appendChild(replayBtn);

                const learnerText = (dialogue.expected || []).join(", ") || "‚Äî";
                const learnerBubble = document.createElement("div");
                learnerBubble.className = "dialogue-bubble learner-bubble";
                learnerBubble.innerHTML = `<div><em>Your reply:</em> ${learnerText}</div>`;

                entry.append(tutorBubble, learnerBubble);
                previewDialogues.appendChild(entry);
            });
            console.log("dialogue entries rendered:", previewDialogues.childElementCount);
        } catch (dialogueErr) {
            console.error("Failed to render dialogues:", dialogueErr);
        }

        const vocabulary = lesson.vocabulary || lesson.phrases || [];
        console.log("vocabulary count:", vocabulary.length);
        if (vocabulary.length) {
            const vocabContainer = document.createElement("div");
            vocabContainer.className = "dialogue-entry vocabulary-entry";
            const heading = document.createElement("p");
            heading.className = "vocabulary-heading";
            heading.textContent = "Key phrases";
            vocabContainer.appendChild(heading);

            const list = document.createElement("ul");
            list.className = "vocabulary-list";
            vocabulary.forEach((item) => {
                const li = document.createElement("li");
                li.className = "vocabulary-item";
                const polish = item?.pl || item?.phrase || item?.polish || "";
                const english = item?.en || item?.translation || item?.english || "";
                const phraseText = english ? `${polish} ‚Äî ${english}` : polish;

                const label = document.createElement("span");
                label.className = "vocabulary-phrase";
                label.textContent = phraseText;
                li.appendChild(label);

                const phraseToPlay = polish || phraseText;
                const playBtn = document.createElement("button");
                playBtn.type = "button";
                playBtn.className = "replay-audio-btn vocabulary-play-btn";
                playBtn.setAttribute("aria-label", `Play audio for ${phraseToPlay}`);
                playBtn.title = `Play audio for ${phraseToPlay}`;
                playBtn.innerHTML = "&#9658;";
                if (phraseToPlay.trim()) {
                    playBtn.addEventListener("click", (event) => {
                        event.stopPropagation();
                        playAudioFor(phraseToPlay);
                    });
                } else {
                    playBtn.disabled = true;
                }
                li.appendChild(playBtn);
                list.appendChild(li);
            });
            vocabContainer.appendChild(list);
            previewDialogues.appendChild(vocabContainer);
        }
        console.log("preview container final child count:", previewDialogues.childElementCount);
    }

    function updateResumeButtons(lessonId, lessonTitle) {
        const displayTitle = lessonTitle || lessonId || "lesson";
        resumeButtons.forEach((button) => {
            button.dataset.lessonId = lessonId;
        });
        resumeLabels.forEach((label) => {
            label.textContent = `Resume ${displayTitle}`;
        });
    }

    async function ensureEnglishTitle(entry) {
        if (entry.title_en) {
            return entry.title_en;
        }
        if (lessonEnglishCache[entry.id]) {
            return lessonEnglishCache[entry.id];
        }
        try {
            const payload = await apiGet(`/api/lesson/get?lesson_id=${encodeURIComponent(entry.id)}`);
            const lessonData = payload?.data;
            const fallback =
                lessonData?.title_en ||
                lessonData?.translation ||
                lessonData?.summary?.title_en ||
                "";
            lessonEnglishCache[entry.id] = fallback;
            return fallback;
        } catch (error) {
            return "";
        }
    }

    async function enrichCatalogEntries(entries) {
        const enriched = [];
        for (const entry of entries) {
            const englishTitle = await ensureEnglishTitle(entry);
            enriched.push({
                ...entry,
                title_en: englishTitle,
            });
        }
        return enriched;
    }

    function renderCatalog(entries) {
        catalogList.innerHTML = "";
        if (!entries?.length) {
            catalogList.classList.add("hidden");
            catalogEmpty.classList.remove("hidden");
            catalogEmpty.innerHTML = `<p>üìö No lessons available yet</p><p>Try refreshing or browsing all categories.</p>`;
            return;
        }

        catalogEmpty.classList.add("hidden");
        catalogList.classList.remove("hidden");

        entries.forEach((entry) => {
            const row = document.createElement("div");
            row.className = "py-4 flex items-center justify-between gap-4";

            const details = document.createElement("div");
            const polishTitle = entry.title_pl || entry.title_en || entry.id;
            const englishTitle = entry.title_en || entry.translation || "";
            const bilingualTitle = englishTitle ? `${polishTitle} ‚Äî ${englishTitle}` : polishTitle;
            details.innerHTML = `
                <p class="font-medium">${bilingualTitle}</p>
                <p class="text-sm text-white/70">${entry.module || entry.part || "Course module"}</p>
            `;

            const action = document.createElement("button");
            action.className = "px-4 py-2 bg-white/10 hover:bg-white/20 text-sm rounded-xl";
            action.textContent = "Load lesson";
            action.addEventListener("click", () => startLessonById(entry.id));

            row.appendChild(details);
            row.appendChild(action);
            catalogList.appendChild(row);
        });
    }

    async function apiGet(url) {
        const response = await fetch(url);
        if (!response.ok) {
            let detail = "";
            try {
                const data = await response.json();
                detail = data.detail || data.message || response.statusText;
            } catch (err) {
                detail = response.statusText;
            }
            throw new Error(detail);
        }
        return response.json();
    }

    async function apiPost(url, body) {
        const response = await fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
            },
            body: JSON.stringify(body),
        });
        if (!response.ok) {
            let detail = "";
            try {
                const data = await response.json();
                detail = data.detail || data.message || response.statusText;
            } catch (err) {
                detail = response.statusText;
            }
            throw new Error(detail);
        }
        return response.json();
    }

    async function playTutorAudio(text) {
        const normalizedText = (text || "").trim();
        if (!normalizedText) {
            showToast("Audio unavailable", "No tutor dialogue available to replay.", "error");
            return;
        }

        const playAudioUrl = async (audioUrl) => {
            const audio = new Audio(audioUrl);
            try {
                await audio.play();
                showAudioToast();
            } catch (playErr) {
                console.error("Playback failed:", playErr);
                showToast("Playback failed", "Unable to play tutor audio.", "error");
            }
        };

        const cachedUrl = tutorAudioCache.get(normalizedText);
        if (cachedUrl) {
            await playAudioUrl(cachedUrl);
            return;
        }

        try {
            const speedMap = {
                slow: 0.8,
                normal: 1.0,
                fast: 1.2,
            };
            const configuredSpeed = userSettings?.audio_speed;
            const parsedSpeed =
                typeof configuredSpeed === "number"
                    ? configuredSpeed
                    : typeof configuredSpeed === "string"
                    ? parseFloat(configuredSpeed)
                    : NaN;
            const numericSpeed =
                (typeof configuredSpeed === "string" && speedMap[configuredSpeed]) ||
                (Number.isFinite(parsedSpeed) ? parsedSpeed : null);
            const speedValue = numericSpeed || 1.0;
            const payload = {
                text: normalizedText,
                speed: speedValue,
                user_id: currentUserId,
            };
            const resp = await apiPost("/api/audio/generate", payload);
            const audioUrl = resp?.data?.audio_url || resp?.audio_url;
            if (!audioUrl) {
                throw new Error("Audio URL missing from response.");
            }
            tutorAudioCache.set(normalizedText, audioUrl);
            await playAudioUrl(audioUrl);
        } catch (error) {
            console.error("Failed to replay tutor audio:", error);
            showToast("Audio unavailable", error.message || "Unable to replay tutor audio.", "error");
        }
    }

    async function playAudioFor(text) {
        const trimmed = (text || "").trim();
        if (!trimmed) {
            showToast("Audio unavailable", "No phrase provided for audio playback.", "error");
            return;
        }
        try {
            const response = await fetch("/api/audio/generate", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Accept: "application/json",
                },
                body: JSON.stringify({ text: trimmed }),
            });
            if (!response.ok) {
                throw new Error("Unable to generate audio.");
            }
            const contentType = response.headers.get("content-type") || "";
            let audioBlob;
            if (contentType.includes("application/json")) {
                const data = await response.json();
                const audioUrl = data?.data?.audio_url || data?.audio_url;
                if (!audioUrl) {
                    throw new Error("Audio URL missing from response.");
                }
                const blobResp = await fetch(audioUrl);
                if (!blobResp.ok) {
                    throw new Error("Unable to download generated audio.");
                }
                audioBlob = await blobResp.blob();
            } else {
                audioBlob = await response.blob();
            }
            const objectUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(objectUrl);
            audio.play();
        } catch (error) {
            console.error("Failed to play phrase audio:", error);
            showToast("Audio unavailable", error.message || "Unable to play phrase audio.", "error");
        }
    }

    async function startLessonById(lessonId, options = {}) {
        const { silent = false } = options;
        if (!lessonId) {
            if (!silent) {
                showToast("Missing data", "Lesson identifier is not available.", "error");
            }
            return;
        }
        try {
            const label = silent ? null : `Lesson ${lessonId}`;
            setPreviewLoading(label ? `Loading ${label}‚Ä¶` : "Loading lesson‚Ä¶");
            if (!silent) {
                showToast("Loading lesson‚Ä¶", "Fetching lesson data from the tutor.", "info");
            }
            const payload = await apiGet(`/api/lesson/get?lesson_id=${encodeURIComponent(lessonId)}`);
            console.log("Lesson payload received for", lessonId, payload);
            const lessonData = payload?.data;
            const resolvedLessonId = lessonData?.id || lessonId;
            const title = lessonData?.title || resolvedLessonId;
            renderLessonPreview(lessonData);
            updateResumeButtons(resolvedLessonId, title);
            currentLessonId = resolvedLessonId;
            if (featuredCard && featuredLessonId) {
                featuredCard.classList.toggle("is-active", resolvedLessonId === featuredLessonId);
            }
            if (!silent) {
                showToast("Lesson ready", `Lesson "${title}" loaded successfully.`, "success");
            }
        } catch (error) {
            if (!silent) {
                showToast("Lesson unavailable", error.message || "Unable to load lesson.", "error");
            }
            renderLessonPreview(null);
        }
    }

    async function startRecommendedLesson() {
        try {
            showToast("Preparing recommendation‚Ä¶", "Looking at your lesson catalog.", "info");
            const catalog = await apiGet("/api/lesson/catalog");
            const entries = catalog?.data?.entries || [];
            if (!entries.length) {
                throw new Error("No lessons available in catalog.");
            }
            const nextLesson = entries[0];
            await startLessonById(nextLesson.id || nextLesson.slug || nextLesson.title);
        } catch (error) {
            showToast("No recommendation", error.message || "Unable to find a recommended lesson.", "error");
        }
    }

    async function openLessonLibrary() {
        try {
            showToast("Loading catalog‚Ä¶", "Fetching the full lesson list.", "info");
            const catalog = await apiGet("/api/lesson/catalog");
            const entries = catalog?.data?.entries || [];
            if (!entries.length) {
                showToast("No lessons found", "Lesson catalog is empty.", "error");
                return;
            }
            const enrichedEntries = await enrichCatalogEntries(entries);
            const sample = enrichedEntries
                .slice(0, 3)
                .map((entry) => entry.title_pl || entry.title_en || entry.id)
                .join(", ");
            renderCatalog(enrichedEntries);
            showToast("Catalog ready", `Recent lessons: ${sample}`, "success");
        } catch (error) {
            showToast("Catalog unavailable", error.message || "Unable to load lessons.", "error");
        }
    }

    document.querySelectorAll("[data-action='start-lesson']").forEach(btn => {
        btn.addEventListener("click", (event) => {
            const lessonId = event.currentTarget.dataset.lessonId;
            startLessonById(lessonId);
        });
    });

    resumeButtons.forEach(button => {
        button.addEventListener("click", (event) => {
            const lessonId = event.currentTarget.dataset.lessonId;
            startLessonById(lessonId);
        });
    });

    const recommendedButton = document.querySelector("[data-action='start-recommended']");
    if (recommendedButton) {
        recommendedButton.addEventListener("click", startRecommendedLesson);
    }

    const libraryButton = document.querySelector("[data-action='open-library']");
    if (libraryButton) {
        libraryButton.addEventListener("click", openLessonLibrary);
    }

    resetLessonPreview();

    const initialLessonId = resumeButtons[0]?.dataset.lessonId;
    if (initialLessonId) {
        startLessonById(initialLessonId, { silent: true });
    }
});
</script>
</body>
</html>
