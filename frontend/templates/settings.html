<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient Polish Tutor – Settings</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/output.css">
    <link rel="stylesheet" href="/static/css/dashboard-modern.css">
    <link rel="stylesheet" href="/static/css/modern-ui.css">
</head>
<body class="settings-body" data-user-id="1">
    <div class="settings-wrapper">
        <header class="settings-header">
            <div class="settings-header-text">
                <p class="settings-eyebrow">Control Center</p>
                <h1 class="settings-title">Tutor &amp; Voice Preferences</h1>
                <p class="settings-subtitle">Keep your conversational tutor aligned with your goals.</p>
            </div>
            <a href="/" class="settings-back">← Back to dashboard</a>
        </header>

        <section class="settings-summary">
            <article class="settings-card">
                <p class="settings-card-label">Voice</p>
                <h2>Speaking style</h2>
                <p class="settings-card-text">Tune the AI tutor voice, tempo and translation hints to match your preferred pace.</p>
            </article>
            <article class="settings-card">
                <p class="settings-card-label">Mic</p>
                <h2>Conversation input</h2>
                <p class="settings-card-text">Switch between push-to-talk or hands-free drills for pronunciation practice.</p>
            </article>
            <article class="settings-card">
                <p class="settings-card-label">Focus</p>
                <h2>Learning mode</h2>
                <p class="settings-card-text">Choose the tutor persona and UI language that keeps you motivated.</p>
            </article>
        </section>

        <main class="settings-main">
            <section class="settings-form-card">
                <div class="settings-form-header">
                    <div>
                        <p class="settings-form-label">Profile</p>
                        <h3>Volodymyr • Learner profile</h3>
                    </div>
                    <p id="settings-status" class="settings-status">Settings not loaded</p>
                </div>

                <form id="settings-form" class="settings-form-grid">
                    <div class="settings-field">
                        <label for="settings-voice-mode">Voice mode</label>
                        <select id="settings-voice-mode">
                            <option value="offline">Offline (faster)</option>
                            <option value="online">Online (HQ)</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="settings-audio-speed">Audio speed</label>
                        <select id="settings-audio-speed">
                            <option value="slow">Slow</option>
                            <option value="normal">Normal</option>
                            <option value="fast">Fast</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="settings-translation">Translations</label>
                        <select id="settings-translation">
                            <option value="smart">Smart (contextual)</option>
                            <option value="show">Always show</option>
                            <option value="hide">Hide</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="settings-mic-mode">Mic activation</label>
                        <select id="settings-mic-mode">
                            <option value="tap">Tap to speak</option>
                            <option value="hold">Hold to speak</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="settings-theme">Theme</label>
                        <select id="settings-theme">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="dyslexia">Dyslexia-friendly</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="settings-language">Interface language</label>
                        <select id="settings-language">
                            <option value="en">English</option>
                            <option value="pl">Polski</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="settings-tutor-mode">Tutor personality</label>
                        <select id="settings-tutor-mode">
                            <option value="coach">Coach (balanced)</option>
                            <option value="drill">Drill (intense)</option>
                            <option value="teacher">Teacher (detailed)</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="settings-voice">Tutor voice</label>
                        <select id="settings-voice">
                            <option value="neutral">Neutral</option>
                            <option value="female">Female</option>
                            <option value="male">Male</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="settings-confidence">Confidence slider</label>
                        <div class="settings-slider-row">
                            <input id="settings-confidence" type="range" min="1" max="5" value="3" class="settings-slider">
                            <div class="settings-slider-value" id="settings-confidence-value">3</div>
                        </div>
                    </div>
                </form>

                <div class="settings-actions">
                    <button type="button" id="settings-refresh" class="btn-outline">Reload</button>
                    <button type="button" id="settings-save" class="btn-primary">Save changes</button>
                </div>
            </section>
        </main>
    </div>

    <script src="/static/js/theme.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const settingsStatus = document.getElementById("settings-status");
        const settingsForm = document.getElementById("settings-form");
        const settingsVoiceMode = document.getElementById("settings-voice-mode");
        const settingsAudioSpeed = document.getElementById("settings-audio-speed");
        const settingsTranslation = document.getElementById("settings-translation");
        const settingsMicMode = document.getElementById("settings-mic-mode");
        const settingsTheme = document.getElementById("settings-theme");
        const settingsLanguage = document.getElementById("settings-language");
        const settingsTutorMode = document.getElementById("settings-tutor-mode");
        const settingsVoice = document.getElementById("settings-voice");
        const settingsConfidence = document.getElementById("settings-confidence");
        const settingsConfidenceValue = document.getElementById("settings-confidence-value");
        const settingsSave = document.getElementById("settings-save");
        const settingsRefresh = document.getElementById("settings-refresh");
        const DEFAULT_USER_ID = Number(document.body.dataset.userId || "1");
        let loading = false;

        function setStatus(text, variant = "muted") {
            if (!settingsStatus) return;
            const palette = {
                muted: "text-slate-400",
                info: "text-blue-300",
                success: "text-emerald-300",
                error: "text-rose-300",
            };
            settingsStatus.textContent = text;
            settingsStatus.className = `text-sm ${palette[variant] || palette.muted}`;
        }

        const apiGet = (url) => fetch(url).then(async (res) => {
            if (!res.ok) {
                let detail = res.statusText;
                try {
                    const payload = await res.json();
                    detail = payload.detail || payload.message || detail;
                } catch (_) {}
                throw new Error(detail);
            }
            return res.json();
        });

        const apiPost = (url, body) => fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
        }).then(async (res) => {
            if (!res.ok) {
                let detail = res.statusText;
                try {
                    const payload = await res.json();
                    detail = payload.detail || payload.message || detail;
                } catch (_) {}
                throw new Error(detail);
            }
            return res.json();
        });

        function populate(settings) {
            if (!settingsForm || !settings) return;
            const setVal = (el, val, def) => el && (el.value = val ?? def);
            setVal(settingsVoiceMode, settings.voice_mode, "offline");
            setVal(settingsAudioSpeed, settings.audio_speed, "normal");
            setVal(settingsTranslation, settings.translation, "smart");
            setVal(settingsMicMode, settings.mic_mode, "tap");
            setVal(settingsTheme, settings.theme, "light");
            setVal(settingsLanguage, settings.language, "en");
            setVal(settingsTutorMode, settings.tutor_mode, "coach");
            setVal(settingsVoice, settings.voice, "neutral");
            if (settingsConfidence) {
                const value = Number(settings.confidence_slider ?? 3);
                settingsConfidence.value = String(value);
                if (settingsConfidenceValue) settingsConfidenceValue.textContent = String(value);
            }
        }

        async function loadSettings() {
            if (!settingsForm || loading) return;
            try {
                loading = true;
                setStatus("Loading settings...", "info");
                const payload = await apiGet(`/api/settings/get?user_id=${DEFAULT_USER_ID}`);
                populate(payload?.data);
                setStatus("Settings synced", "success");
            } catch (error) {
                setStatus(error.message || "Failed to load settings", "error");
            } finally {
                loading = false;
            }
        }

        async function saveSettings() {
            if (!settingsForm || loading) return;
            const payload = {
                user_id: DEFAULT_USER_ID,
                voice_mode: settingsVoiceMode?.value,
                audio_speed: settingsAudioSpeed?.value,
                translation: settingsTranslation?.value,
                mic_mode: settingsMicMode?.value,
                tutor_mode: settingsTutorMode?.value,
                voice: settingsVoice?.value,
                audio_output: "speakers",
                theme: settingsTheme?.value,
                language: settingsLanguage?.value,
                confidence_slider: settingsConfidence ? Number(settingsConfidence.value) : 3,
                profile_template: null,
            };
            try {
                loading = true;
                setStatus("Saving...", "info");
                await apiPost("/api/settings/update", payload);
                setStatus("Settings saved", "success");
            } catch (error) {
                setStatus(error.message || "Failed to save", "error");
            } finally {
                loading = false;
            }
        }

        if (settingsConfidence && settingsConfidenceValue) {
            settingsConfidence.addEventListener("input", () => {
                settingsConfidenceValue.textContent = settingsConfidence.value;
            });
        }

        settingsRefresh?.addEventListener("click", loadSettings);
        settingsSave?.addEventListener("click", saveSettings);

        loadSettings();
    });
    </script>
</body>
</html>
